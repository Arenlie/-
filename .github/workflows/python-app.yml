name: Python application

on:
  push:
    branches: [ master ]
    paths:  # 更清晰的路径表达式
      - '**'
  pull_request:
    branches: [ master ]
    paths:
      - '**'

jobs:
  build:
    runs-on: windows-latest
    env:  # 新增环境变量
      PYTHON_VERSION: '3.9'
      BUILD_SCRIPT: main.py 

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4  # 升级到最新版
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'  # 启用依赖缓存

    - name: Install dependencies
      shell: pwsh  # 显式指定PowerShell
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pytest pyinstaller
        if (Test-Path requirements.txt)  { 
          pip install -r requirements.txt  
        } else { 
          Write-Host "No requirements.txt  found" 
        }

    - name: Build EXE
      run: |
        # 确保图标路径存在
        if (-not (Test-Path images\logo.ico))  {
          Write-Error "Icon file not found"
          exit 1
        }
        pyinstaller -F --noconsole --icon=images\logo.ico  ${{ env.BUILD_SCRIPT }}

    - name: Upload EXE as artifact
      uses: actions/upload-artifact@v4  # 升级到最新版
      with:
        name: windows-exe-${{ github.run_id  }}  # 添加唯一标识
        path: dist/main.exe 
        retention-days: 7  # 设置过期时间
